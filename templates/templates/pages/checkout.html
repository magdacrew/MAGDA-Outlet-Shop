<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - MAGDA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="checkout-page">
    <!-- Incluir Navbar -->
    {% include 'layouts/navbar.html' %}

    <div class="checkout-wrapper">
        <div class="checkout-container">
            <h1 class="checkout-title">Finalizar Compra</h1>
            
            <div class="checkout-content">
                <form method="POST" action="/finalizar_compra" class="checkout-form">
                    <div class="checkout-linha">
                        <!-- Endereço -->
                        <div class="checkout-coluna">
                            <h2>Endereço de Entrega</h2>
                            
                            <div class="form-group">
                                <label>CEP</label>
                                <input type="text" name="cep" placeholder="00000-000" 
                                       value="{{ endereco.cep if endereco else '' }}" required>
                            </div>
                            
                            <div class="form-duplo">
                                <div class="form-group">
                                    <label>Rua</label>
                                    <input type="text" name="logradouro" 
                                           value="{{ endereco.logradouro if endereco else '' }}" required>
                                </div>
                                <div class="form-group">
                                    <label>Número</label>
                                    <input type="text" name="numero" 
                                           value="{{ endereco.numero if endereco else '' }}" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Complemento</label>
                                <input type="text" name="complemento"
                                       value="{{ endereco.complemento if endereco else '' }}">
                            </div>
                            
                            <div class="form-duplo">
                                <div class="form-group">
                                    <label>Bairro</label>
                                    <input type="text" name="bairro" 
                                           value="{{ endereco.bairro if endereco else '' }}" required>
                                </div>
                                <div class="form-group">
                                    <label>Cidade</label>
                                    <input type="text" name="cidade" 
                                           value="{{ endereco.cidade if endereco else '' }}" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Estado</label>
                                <select name="estado" required>
                                    <option value="">Selecione</option>
                                    {% set estados = ['AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'] %}
                                    {% for estado in estados %}
                                    <option value="{{ estado }}" 
                                            {% if endereco and endereco.estado == estado %}selected{% endif %}>
                                        {{ estado }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Destinatário</label>
                                <input type="text" name="destinatario" 
                                       value="{{ endereco.destinatario if endereco else (usuario.nome_completo if usuario else '') }}" 
                                       required>
                            </div>
                        </div>
                        
                        <!-- Pagamento -->
                        <div class="checkout-coluna">
                            <h2>Pagamento</h2>
                            
                            <div class="form-group">
                                <label>Forma de Pagamento</label>
                                <select name="forma_pagamento" required>
                                    <option value="simulacao">Simulação (Projeto)</option>
                                    <option value="pix">PIX</option>
                                    <option value="cartao_credito">Cartão de Crédito</option>
                                    <option value="cartao_debito">Cartão de Débito</option>
                                    <option value="boleto">Boleto</option>
                                </select>
                            </div>
                            
                            <!-- Para nota fiscal -->
                            <div class="form-group">
                                <label>CPF para Nota Fiscal (opcional)</label>
                                <input type="text" name="cpf_cnpj_nota" value="{{ usuario.cpf if usuario else '' }}">
                            </div>
                            
                            <!-- Resumo do Pedido -->
                            <div class="checkout-resumo">
                                <h3>Resumo do Pedido</h3>
                                
                                <div class="resumo-linha">
                                    <span>Itens ({{ itens|length }})</span>
                                    <span>R$ {{ "%.2f"|format(subtotal) }}</span>
                                </div>
                                
                                <div class="resumo-linha">
                                    <span>Frete</span>
                                    <span class="frete-gratis">Grátis</span>
                                </div>
                                
                                <div class="resumo-total">
                                    <span>Total</span>
                                    <span class="total-valor">R$ {{ "%.2f"|format(total) }}</span>
                                </div>
                                
                                <button type="submit" class="btn-confirmar" href="/finalizar_compra">
                                    Confirmar Compra
                                </button>
                                
                                <p class="checkout-aviso">
                                    <small>⚠️ Esta é uma simulação para projeto. Nenhum pagamento real será processado.</small>
                                </p>
                            </div>
                        </div>
                    </div>
                </form>
                
                <!-- Itens do Pedido -->
                <div class="checkout-itens">
                    <h3>Seus Itens</h3>
                    
                    {% for item in itens %}
                    <div class="checkout-item">
                        <div class="item-imagem">
                            <img src="{{ url_for('static', filename='uploads/' ~ item.imagem) if item.imagem else url_for('static', filename='images/default.png') }}" 
                                 alt="{{ item.nome }}">
                        </div>
                        
                        <div class="item-detalhes">
                            <h4>{{ item.nome }}</h4>
                            {% if item.tamanho_nome %}
                            <p>Tamanho: {{ item.tamanho_nome }}</p>
                            {% endif %}
                            {% if item.cor_nome %}
                            <p>Cor: {{ item.cor_nome }}</p>
                            {% endif %}
                            <p>{{ item.quantidade }} × R$ {{ "%.2f"|format(item.preco) }}</p>
                        </div>
                        
                        <div class="item-subtotal">
                            R$ {{ "%.2f"|format(item.subtotal) }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Incluir Footer -->
    {% include 'layouts/footer.html' %}

    <script>
    // Buscar CEP automaticamente
    document.querySelector('input[name="cep"]').addEventListener('blur', function() {
        const cep = this.value.replace(/\D/g, '');
        
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(response => response.json())
                .then(data => {
                    if (!data.erro) {
                        document.querySelector('input[name="logradouro"]').value = data.logradouro || '';
                        document.querySelector('input[name="bairro"]').value = data.bairro || '';
                        document.querySelector('input[name="cidade"]').value = data.localidade || '';
                        document.querySelector('select[name="estado"]').value = data.uf || '';
                    }
                })
                .catch(error => console.error('Erro ao buscar CEP:', error));
        }
    });
    </script>
</body>
</html>