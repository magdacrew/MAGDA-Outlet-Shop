<!-- templates/pages/checkout_dados.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Dados de Entrega | MAGDA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" type="text/css" href="static/style.css">
    <link rel="icon" href="static/images/simple_magda_logo.png" type="image/png">
</head>
<body>
    {% include 'layouts/navbar.html' %}

    <div class="checkout-container">
        <!-- Lado esquerdo: Formulário de dados -->
        <div class="checkout-left">
            <h1 class="checkout-title">Finalizar Compra</h1>
            
            <!-- Dados de contato -->
            <div class="checkout-section">
                <div class="section-title">
                    <span>Dados de Contato</span>
                    <small>Puxado do seu cadastro</small>
                </div>
                
                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" class="form-control" value="{{ usuario.email }}" readonly>
                </div>
                
                <div class="form-group">
                    <label>Telefone com DDD</label>
                    <input type="tel" class="form-control" value="{{ usuario.telefone }}" readonly>
                </div>
            </div>
            
            <!-- Dados para entrega -->
            <form id="checkoutForm" method="POST" action="{{ url_for('checkout_salvar_dados') }}">
                <input type="hidden" name="usuario_id" value="{{ session.usuario_id }}">
                
                <div class="checkout-section">
                    <div class="section-title">
                        <span>Dados para Entrega</span>
                    </div>
                    
                    <div class="row">
                        <div class="form-group">
                            <label>Nome *</label>
                            <input type="text" class="form-control" name="nome" value="{{ usuario.nome_completo.split(' ')[0] }}" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Sobrenome *</label>
                            <input type="text" class="form-control" name="sobrenome" value="{{ usuario.nome_completo.split(' ', 1)[1] if usuario.nome_completo.split(' ', 1)|length > 1 else '' }}" required>
                        </div>
                    </div>
                    
                    <div class="cep-container">
                        <div class="form-group">
                            <label>CEP *</label>
                            <input type="text" class="form-control" id="cep" name="cep" maxlength="9" 
                                   pattern="\d{5}-\d{3}" placeholder="00000-000" required>
                        </div>
                        
                        <button type="button" class="btn-continuar" id="btnBuscarCep" style="height: fit-content; padding: 12px 20px;">
                            Buscar Endereço
                        </button>
                    </div>
                    
                    <!-- Endereço será preenchido pelo JavaScript -->
                    <div id="enderecoContainer" style="display: none;">
                        <div class="form-group">
                            <label>Rua/Avenida</label>
                            <input type="text" class="form-control" id="rua" name="rua" readonly>
                        </div>
                        
                        <div class="row">
                            <div class="form-group">
                                <label>Bairro</label>
                                <input type="text" class="form-control" id="bairro" name="bairro" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label>Cidade</label>
                                <input type="text" class="form-control" id="cidade" name="cidade" readonly>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="form-group">
                                <label>Estado</label>
                                <input type="text" class="form-control" id="estado" name="estado" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label>Número *</label>
                                <input type="text" class="form-control" id="numero" name="numero" required>
                            </div>
                        </div>
                        
                        <div class="sem-numero">
                            <input type="checkbox" id="semNumero" name="sem_numero">
                            <label for="semNumero">Sem número</label>
                        </div>
                        
                        <div class="form-group">
                            <label>Complemento (opcional)</label>
                            <input type="text" class="form-control" name="complemento" placeholder="Apto, bloco, etc.">
                        </div>
                    </div>
                </div>
                
                <!-- Formas de envio -->
                <div class="checkout-section">
                    <div class="section-title">
                        <span>Forma de Envio</span>
                    </div>
                    
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="frete" value="padrao" checked hidden>
                            <div class="radio-header">
                                <div class="radio-title">Entrega Padrão</div>
                                <div class="radio-price">R$ 15,90</div>
                            </div>
                            <div class="radio-desc">Chega em até 8 dias úteis</div>
                        </label>
                        
                        <label class="radio-option">
                            <input type="radio" name="frete" value="expressa" hidden>
                            <div class="radio-header">
                                <div class="radio-title">Entrega Expressa</div>
                                <div class="radio-price">R$ 29,90</div>
                            </div>
                            <div class="radio-desc">Chega em até 3 dias úteis</div>
                        </label>
                        
                        <label class="radio-option">
                            <input type="radio" name="frete" value="economica" hidden>
                            <div class="radio-title">Entrega Econômica</div>
                            <div class="radio-price">R$ 9,90</div>
                            <div class="radio-desc">Chega em até 15 dias úteis</div>
                        </label>
                    </div>
                </div>
                
                <!-- Dados para nota fiscal -->
                <div class="checkout-section">
                    <div class="section-title">
                        <span>Dados para Nota Fiscal</span>
                    </div>
                    
                    <div class="form-group">
                        <label>CPF/CNPJ *</label>
                        <input type="text" class="form-control" name="cpf_cnpj" value="{{ usuario.cpf }}" 
                               pattern="(\d{3}\.\d{3}\.\d{3}-\d{2})|(\d{2}\.\d{3}\.\d{3}/\d{4}-\d{2})" 
                               placeholder="000.000.000-00 ou 00.000.000/0000-00" required>
                    </div>
                </div>
                
                <button type="submit" class="btn-continuar">
                    Continuar para Pagamento →
                </button>
            </form>
        </div>
        
        <!-- Lado direito: Resumo do pedido -->
        <div class="checkout-right">
            <h3 class="checkout-title">Seu Pedido</h3>
            
            <!-- Itens do carrinho -->
            <div class="checkout-items">
                {% for item in itens %}
                <div class="checkout-item">
                    <img src="{{ url_for('static', filename='uploads/' + item.imagem) if item.imagem else url_for('static', filename='images/default.png') }}" 
                         alt="{{ item.nome }}" class="checkout-item-img">
                    <div class="checkout-item-info">
                        <div class="checkout-item-name">{{ item.nome }}</div>
                        {% if item.tamanho_nome or item.cor_nome %}
                        <div class="checkout-item-details">
                            {% if item.tamanho_nome %}Tamanho: {{ item.tamanho_nome }}{% endif %}
                            {% if item.cor_nome %}<br>Cor: {{ item.cor_nome }}{% endif %}
                        </div>
                        {% endif %}
                        <div class="checkout-item-price">
                            R$ {{ "%.2f"|format(item.preco|float) }}
                            <small style="font-weight: normal; color: #666;">× {{ item.quantidade }}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Resumo de valores -->
            <div class="checkout-summary">
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span>R$ {{ "%.2f"|format(subtotal|float) }}</span>
                </div>
                
                <div class="summary-row" id="freteSummary">
                    <span>Frete</span>
                    <span>R$ 15,90</span>
                </div>
                
                <div class="summary-row total">
                    <span>Total</span>
                    <span id="totalSummary">R$ {{ "%.2f"|format(subtotal|float + 15.90) }}</span>
                </div>
            </div>
        </div>
    </div>

    {% include 'layouts/footer.html' %}

    <script>
        // Formatação do CEP
        document.getElementById('cep').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.replace(/^(\d{5})(\d)/, '$1-$2');
            }
            e.target.value = value;
        });
        
        // Buscar endereço pelo CEP
        document.getElementById('btnBuscarCep').addEventListener('click', function() {
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            
            if (cep.length !== 8) {
                alert('Digite um CEP válido com 8 dígitos');
                return;
            }
            
            // Simulação de busca de CEP (em produção, usar API como ViaCEP)
            // Aqui vamos usar dados de exemplo
            const enderecosExemplo = {
                '01001000': {
                    rua: 'Praça da Sé',
                    bairro: 'Sé',
                    cidade: 'São Paulo',
                    estado: 'SP'
                },
                '20040002': {
                    rua: 'Rua Primeiro de Março',
                    bairro: 'Centro',
                    cidade: 'Rio de Janeiro',
                    estado: 'RJ'
                },
                '30130005': {
                    rua: 'Rua da Bahia',
                    bairro: 'Centro',
                    cidade: 'Belo Horizonte',
                    estado: 'MG'
                }
            };
            
            // Simula delay da API
            setTimeout(() => {
                if (enderecosExemplo[cep]) {
                    const endereco = enderecosExemplo[cep];
                    document.getElementById('rua').value = endereco.rua;
                    document.getElementById('bairro').value = endereco.bairro;
                    document.getElementById('cidade').value = endereco.cidade;
                    document.getElementById('estado').value = endereco.estado;
                    document.getElementById('enderecoContainer').style.display = 'block';
                    document.getElementById('numero').focus();
                } else {
                    // Se não encontrar, permite digitar manualmente
                    document.getElementById('enderecoContainer').style.display = 'block';
                    document.getElementById('rua').readOnly = false;
                    document.getElementById('bairro').readOnly = false;
                    document.getElementById('cidade').readOnly = false;
                    document.getElementById('estado').readOnly = false;
                    document.getElementById('rua').focus();
                }
            }, 500);
        });
        
        // Controle "Sem número"
        document.getElementById('semNumero').addEventListener('change', function() {
            const numeroInput = document.getElementById('numero');
            if (this.checked) {
                numeroInput.value = 'S/N';
                numeroInput.readOnly = true;
            } else {
                numeroInput.value = '';
                numeroInput.readOnly = false;
            }
        });
        
        // Atualizar valores do frete
        document.querySelectorAll('input[name="frete"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const freteValores = {
                    'padrao': 15.90,
                    'expressa': 29.90,
                    'economica': 9.90
                };
                
                const frete = freteValores[this.value] || 15.90;
                const subtotal = {{ subtotal|float }};
                const total = subtotal + frete;
                
                document.getElementById('freteSummary').innerHTML = `
                    <span>Frete</span>
                    <span>R$ ${frete.toFixed(2)}</span>
                `;
                
                document.getElementById('totalSummary').textContent = `R$ ${total.toFixed(2)}`;
                
                // Atualiza visualmente a opção selecionada
                document.querySelectorAll('.radio-option').forEach(option => {
                    option.classList.remove('selected');
                });
                this.closest('.radio-option').classList.add('selected');
            });
        });
        
        // Formatação do CPF/CNPJ
        document.querySelector('input[name="cpf_cnpj"]').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length <= 11) {
                // Formata como CPF
                if (value.length > 9) {
                    value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d)/, '$1.$2.$3-$4');
                } else if (value.length > 6) {
                    value = value.replace(/^(\d{3})(\d{3})(\d)/, '$1.$2.$3');
                } else if (value.length > 3) {
                    value = value.replace(/^(\d{3})(\d)/, '$1.$2');
                }
            } else {
                // Formata como CNPJ
                if (value.length > 12) {
                    value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d)/, '$1.$2.$3/$4-$5');
                } else if (value.length > 8) {
                    value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d)/, '$1.$2.$3/$4');
                } else if (value.length > 5) {
                    value = value.replace(/^(\d{2})(\d{3})(\d)/, '$1.$2.$3');
                } else if (value.length > 2) {
                    value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                }
            }
            
            e.target.value = value;
        });
        
        // Inicializar primeira opção de frete como selecionada
        document.querySelector('.radio-option').classList.add('selected');
    </script>
</body>
</html>