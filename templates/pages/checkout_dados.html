<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout de Dados - MAGDA CREW</title>

    <link rel="stylesheet" type="text/css" href="/static/style.css">
    <link rel="icon" href="/static/images/simple_magda_logo.png" type="image/png">
</head>
<body>

    <!-- NAVBAR -->
    {% include 'layouts/navbar.html' %}
    
    <div class="container-chec">
        <div class="form-section">
            <h1>Finalizar Compra</h1>
            
            <form id="checkoutForm" method="POST" action="{{ url_for('checkout_dados') }}">
                <h2>Dados de contato</h2>
                <div class="form-group">
                    <label for="email">E-mail</label>
                    <input type="email" id="email" name="email" value="{{ usuario.email if usuario else '' }}" required readonly>
                </div>

                <h2>Dados para entrega</h2>
                <div class="half-width">
                    <div class="form-group">
                        <label for="nome">Nome</label>
                        <input type="text" id="nome" name="nome" value="{{ usuario.nome if usuario else '' }}" required>
                    </div>
                    <div class="form-group">
                        <label for="sobrenome">Sobrenome</label>
                        <input type="text" id="sobrenome" name="sobrenome" value="{{ usuario.sobrenome if usuario else '' }}" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="telefone">Telefone com DDD</label>
                    <input type="tel" id="telefone" name="telefone" value="{{ usuario.telefone if usuario else '' }}" required>
                </div>

                <div class="form-group">
                    <label for="cep">CEP</label>
                    <div class="cep-group">
                        <input type="text" id="cep" name="cep" value="{{ cep }}" required maxlength="9">
                        <button type="submit" class="btn-cep">Continuar</button>
                    </div>
                </div>

                {% if endereco %}
                <div class="half-width">
                    <div class="form-group">
                        <label for="rua">Rua</label>
                        <input type="text" id="rua" name="rua" value="{{ endereco.logradouro }}" required>
                    </div>
                    <div class="form-group">
                        <label for="bairro">Bairro</label>
                        <input type="text" id="bairro" name="bairro" value="{{ endereco.bairro }}" required>
                    </div>
                </div>
                
                <div class="half-width">
                    <div class="form-group">
                        <label for="cidade">Cidade</label>
                        <input type="text" id="cidade" name="cidade" value="{{ endereco.localidade }}" required>
                    </div>
                    <div class="form-group">
                        <label for="estado">Estado</label>
                        <input type="text" id="estado" name="estado" value="{{ endereco.uf }}" required>
                    </div>
                </div>
                {% endif %}

                <div class="form-group">
                    <label for="numero">Número</label>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="text" id="numero" name="numero" style="width: auto;">
                        <label style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="sem_numero" name="sem_numero">
                            Sem número
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="complemento">Complemento (opcional)</label>
                    <input type="text" id="complemento" name="complemento">
                </div>

                <h2>Entrega</h2>
                <div class="shipping-options" id="shippingOptions">
                    <!-- As opções de frete serão preenchidas pelo JavaScript -->
                </div>

                <h2>Dados para nota fiscal</h2>
                <div class="form-group">
                    <label for="cpf_cnpj">CPF ou CNPJ</label>
                    <input type="text" id="cpf_cnpj" name="cpf_cnpj" value="{{ usuario.cpf if usuario else '' }}" required>
                </div>

                <input type="hidden" id="frete_selecionado" name="frete_selecionado">
                
                <button type="submit" class="btn-continue" id="btnContinuar" disabled>Continuar para Pagamento</button>
            </form>
        </div>

        <div class="summary-section">
            <h2>Resumo do Pedido</h2>
            <div id="carrinho-itens" class="carrinho-itens">
                <!-- Itens serão adicionados dinamicamente aqui -->
            </div>
            
            <div class="price-summary">
                <div class="price-row">
                    <span>Sub-total</span>
                    <span id="subtotal">R$ 0,00</span>
                </div>
                <div class="price-row">
                    <span>Frete</span>
                    <span id="frete">R$ 0,00</span>
                </div>
                <div class="price-row total">
                    <span>Total</span>
                    <span id="total">R$ 0,00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    {% include 'layouts/footer.html' %}
    
    <script>
        // Dados simulados do carrinho (você precisará substituir pelo seu sistema real)
        const cartItems = [
        ];

        // Opções de frete simuladas
        const shippingOptions = [
            { id: 'sedex', nome: 'Sedex', prazo: '1-2 dias úteis', preco: 25.90 },
            { id: 'pac', nome: 'PAC', prazo: '5-10 dias úteis', preco: 15.90 },
            { id: 'expresso', nome: 'Expresso', prazo: '3-5 dias úteis', preco: 35.90 }
        ];

        // Calcular datas de entrega
        function calcularDataEntrega(diasUteis) {
            const hoje = new Date();
            let diasAdicionados = 0;
            while (diasAdicionados < diasUteis) {
                hoje.setDate(hoje.getDate() + 1);
                if (hoje.getDay() !== 0 && hoje.getDay() !== 6) { // Não conta sábado e domingo
                    diasAdicionados++;
                }
            }
            return hoje.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'numeric' });
        }

        // Atualizar resumo do carrinho
        function atualizarResumo() {
            const cartItemsContainer = document.getElementById('carrinho-itens');
            const subtotalElement = document.getElementById('subtotal');
            const freteElement = document.getElementById('frete');
            const totalElement = document.getElementById('total');
            const btnContinuar = document.getElementById('btnContinuar');
            
            let subtotal = 0;
            cartItemsContainer.innerHTML = '';
            
            cartItems.forEach(item => {
                subtotal += item.preco * item.quantidade;
                
                const itemElement = document.createElement('div');
                itemElement.className = 'product-item';
                itemElement.innerHTML = `
                    <img src="${item.imagem}" alt="${item.nome}" class="product-image">
                    <div class="product-info">
                        <strong>${item.nome}</strong>
                        <p>Tamanho: ${item.tamanho} | Cor: ${item.cor}</p>
                        <p>Quantidade: ${item.quantidade}</p>
                        <p>R$ ${item.preco.toFixed(2)}</p>
                    </div>
                `;
                cartItemsContainer.appendChild(itemElement);
            });
            
            subtotalElement.textContent = `R$ ${subtotal.toFixed(2)}`;
            
            // Atualizar opções de frete
            const shippingContainer = document.getElementById('shippingOptions');
            shippingContainer.innerHTML = '';
            
            shippingOptions.forEach(option => {
                const dataEntrega = calcularDataEntrega(parseInt(option.prazo.charAt(0)));
                const optionElement = document.createElement('div');
                optionElement.className = 'shipping-option';
                optionElement.innerHTML = `
                    <input type="radio" name="opcao_frete" value="${option.id}" id="frete_${option.id}" 
                           onchange="selecionarFrete('${option.id}', ${option.preco})">
                    <label for="frete_${option.id}" style="margin-left: 0.5rem;">
                        <strong>${option.nome}</strong> - Chega ${dataEntrega}
                        <br>
                        <span>R$ ${option.preco.toFixed(2)}</span>
                    </label>
                `;
                shippingContainer.appendChild(optionElement);
            });
            
            // Verificar se todos os campos obrigatórios estão preenchidos
            function verificarCampos() {
                const requiredFields = ['nome', 'sobrenome', 'telefone', 'cep', 'cpf_cnpj'];
                const allFilled = requiredFields.every(field => {
                    const element = document.getElementById(field);
                    return element && element.value.trim() !== '';
                });
                
                const freteSelecionado = document.getElementById('frete_selecionado').value;
                const enderecoCompleto = document.getElementById('rua') && document.getElementById('rua').value.trim() !== '';
                
                btnContinuar.disabled = !(allFilled && freteSelecionado && enderecoCompleto);
            }
            
            // Adicionar listeners para verificar campos
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', verificarCampos);
                input.addEventListener('change', verificarCampos);
            });
            
            verificarCampos();
        }

        function selecionarFrete(id, preco) {
            document.getElementById('frete_selecionado').value = id;
            document.getElementById('frete').textContent = `R$ ${preco.toFixed(2)}`;
            
            const subtotal = cartItems.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            const total = subtotal + preco;
            document.getElementById('total').textContent = `R$ ${total.toFixed(2)}`;
            
            // Atualizar estilo da opção selecionada
            document.querySelectorAll('.shipping-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.shipping-option').classList.add('selected');
            
            // Verificar se pode habilitar o botão
            document.getElementById('btnContinuar').disabled = false;
        }

        // Checkbox "Sem número"
        document.getElementById('sem_numero').addEventListener('change', function() {
            const numeroInput = document.getElementById('numero');
            if (this.checked) {
                numeroInput.value = 'S/N';
                numeroInput.disabled = true;
            } else {
                numeroInput.value = '';
                numeroInput.disabled = false;
            }
        });

        // Inicializar
        window.onload = function() {
            atualizarResumo();
            
            // Formatar CEP
            const cepInput = document.getElementById('cep');
            cepInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 5) {
                    value = value.substring(0,5) + '-' + value.substring(5,8);
                }
                e.target.value = value;
            });
            
            // Formatar CPF/CNPJ
            const cpfCnpjInput = document.getElementById('cpf_cnpj');
            cpfCnpjInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    // CPF: 000.000.000-00
                    if (value.length > 3 && value.length <= 6) {
                        value = value.substring(0,3) + '.' + value.substring(3);
                    } else if (value.length > 6 && value.length <= 9) {
                        value = value.substring(0,3) + '.' + value.substring(3,6) + '.' + value.substring(6);
                    } else if (value.length > 9) {
                        value = value.substring(0,3) + '.' + value.substring(3,6) + '.' + value.substring(6,9) + '-' + value.substring(9,11);
                    }
                } else {
                    // CNPJ: 00.000.000/0000-00
                    if (value.length > 2 && value.length <= 5) {
                        value = value.substring(0,2) + '.' + value.substring(2);
                    } else if (value.length > 5 && value.length <= 8) {
                        value = value.substring(0,2) + '.' + value.substring(2,5) + '.' + value.substring(5);
                    } else if (value.length > 8 && value.length <= 12) {
                        value = value.substring(0,2) + '.' + value.substring(2,5) + '.' + value.substring(5,8) + '/' + value.substring(8,12);
                    } else if (value.length > 12) {
                        value = value.substring(0,2) + '.' + value.substring(2,5) + '.' + value.substring(5,8) + '/' + value.substring(8,12) + '-' + value.substring(12,14);
                    }
                }
                e.target.value = value;
            });
        };
    </script>
</body>
</html>