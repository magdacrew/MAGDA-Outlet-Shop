<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ produto.nome }} - MAGDA CREW</title>

    <link rel="stylesheet" type="text/css" href="/static/style.css">
    <link rel="icon" href="/static/images/simple_magda_logo.png" type="image/png">
</head>

<body class="produto-detalhes-page">

    {% include 'layouts/navbar.html' %}

    <div class="produto-detalhes-container">
        <div class="produto-imagem-section">
            <img src="{{ url_for('static', filename='uploads/' ~ produto.imagem) if produto.imagem else url_for('static', filename='images/default.png') }}"
                 alt="{{ produto.nome }}" class="produto-imagem-principal">
            
            <div class="produto-miniaturas">
                <!-- Miniaturas adicionais podem ser adicionadas aqui -->
                <img src="{{ url_for('static', filename='uploads/' ~ produto.imagem) if produto.imagem else url_for('static', filename='images/default.png') }}"
                     alt="{{ produto.nome }}" class="miniatura ativa">
                <!-- Adicione mais miniaturas conforme necessário -->
            </div>
        </div>

        <div class="produto-info-section">
            <h1 class="produto-nome">{{ produto.nome }}</h1>
            
            <div class="produto-preco">
                R$ {{ "%.2f"|format(produto.preco) }}
                {% if produto.preco_original %}
                {% endif %}
            </div>
            
            <div class="produto-descricao">
                <p>{{ produto.descricao }}</p>
            </div>
            
            <form class="produto-opcoes" id="form-produto">
                <div class="opcao-grupo">
                    <label for="tamanho">Tamanho:</label>
                    <select name="tamanho_id" id="tamanho" required>
                        <option disabled selected value="">Selecione...</option>
                        {% for tamanho in tamanhos %}
                        <option value="{{ tamanho.id }}">{{ tamanho.nome }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="opcao-grupo">
                    <label for="cor">Cor:</label>
                    <select name="cor_id" id="cor" required>
                        <option disabled selected value="">Selecione...</option>
                    </select>
                </div>
                
                <div class="opcao-grupo">
                    <label for="quantidade">Quantidade:</label>
                    <div class="quantidade-selector">
                        <button type="button" class="quantidade-btn" id="diminuir">-</button>
                        <input type="number" id="quantidade" name="quantidade" value="1" min="1">
                        <button type="button" class="quantidade-btn" id="aumentar">+</button>
                    </div>
                </div>
                
                    <!-- No formulário, mude o botão -->
                    <div class="produto-acoes">
                        <button type="button" class="btn-adicionar-carrinho" 
                                data-produto-id="{{ produto.id }}">
                            ADICIONAR AO CARRINHO
                        </button>
                    </div>

                    <!-- E também nos produtos relacionados -->
                    {% for produto_relacionado in produtos_relacionados %}
                    <div class="card" data-produto-id="{{ produto_relacionado.id }}">
                        <a href="/visualizacao/{{ produto_relacionado.id }}">  <!-- Corrigido -->
                            <img src="{{ url_for('static', filename='uploads/' ~ produto_relacionado.imagem) if produto_relacionado.imagem else url_for('static', filename='images/default.png') }}"
                                alt="{{ produto_relacionado.nome }}">
                        </a>
                        <div class="produto-nome">{{ produto_relacionado.nome }}</div>
                        <div class="produto-preco">
                            R$ {{ "%.2f"|format(produto_relacionado.preco) }}
                        </div>
                        <button type="button" class="btn-adicionar-card" 
                                data-produto-id="{{ produto_relacionado.id }}">
                            ADICIONAR AO CARRINHO
                        </button>
                    </div>
                    {% endfor %}
                                </div>
                            </div>
                        </section>

    <!-- CORREÇÃO: Div fechada corretamente -->
    <div>
        {% include 'layouts/footer.html' %}
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // Passar os dados do Python para JavaScript
        const tamanhos = {{ tamanhos | tojson }};
        const cores = {{ cores | tojson }};
        
        document.getElementById('tamanho').addEventListener('change', function() {
            const tamanhoId = parseInt(this.value);
            const corSelect = document.getElementById('cor');
            
            // Limpar opções anteriores
            corSelect.innerHTML = '<option disabled selected value="">Selecione uma cor</option>';
            
            // Filtrar cores pelo tamanho selecionado
            const coresFiltradas = cores.filter(cor => cor.tamanho_id === tamanhoId);
            
            if (coresFiltradas.length > 0) {
                coresFiltradas.forEach(cor => {
                    const option = document.createElement('option');
                    option.value = cor.id;
                    option.textContent = cor.nome;
                    corSelect.appendChild(option);
                });
                corSelect.disabled = false;
            } else {
                corSelect.innerHTML = '<option disabled selected value="">Nenhuma cor disponível</option>';
                corSelect.disabled = true;
            }
        });

        document.getElementById('cor').addEventListener('change', function() {
            const corId = parseInt(this.value);
            const tamanhoId = parseInt(document.getElementById('tamanho').value);
            const quantidadeInput = document.getElementById('quantidade');
            
            // Encontrar o estoque para a combinação selecionada
            const corSelecionada = cores.find(cor => cor.id === corId && cor.tamanho_id === tamanhoId);
            const quantidadeDisponivel = corSelecionada ? corSelecionada.quantidade : 0;
            console.log(quantidadeDisponivel);
            
            // Atualizar o atributo max do input de quantidade
            quantidadeInput.max = quantidadeDisponivel;
            if (parseInt(quantidadeInput.value) > quantidadeDisponivel) {
                quantidadeInput.value = quantidadeDisponivel > 0 ? quantidadeDisponivel : 1;
            }
        });

            // Garantir que os botões tenham os eventos corretos
        document.addEventListener('DOMContentLoaded', function() {
        //     // Seu script existente...
            
            // Inicializar botão de adicionar ao carrinho
            const btnAdicionar = document.querySelector('.btn-adicionar-carrinho');
          if (btnAdicionar) {
                btnAdicionar.addEventListener('click', function() {
                   // O script.js já cuida disso
        });
        }
     });
    </script>
</body>
</html>